import{r as c,j as r}from"./index-ykvKE0EL.js";import{S as ct,a as q,d as x,c as h,b as v}from"./index-CVQbyq5b.js";const C="journal.json",H=25e4,X=new TextEncoder,dt=new TextDecoder,ut=e=>r.jsxs("article",{children:[r.jsx("strong",{children:"Journal"}),r.jsx("p",{children:"Notes with optional password encryption."})]}),U=e=>{let n="";for(let a=0;a<e.length;a+=1)n+=String.fromCharCode(e[a]);return btoa(n)},B=e=>{const n=atob(e),a=new Uint8Array(n.length);for(let i=0;i<n.length;i+=1)a[i]=n.charCodeAt(i);return a},N=e=>e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength),Y=async(e,n,a)=>{const i=await crypto.subtle.importKey("raw",X.encode(e),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:N(n),iterations:a,hash:"SHA-256"},i,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])},V=async(e,n)=>{const a=crypto.getRandomValues(new Uint8Array(16)),i=crypto.getRandomValues(new Uint8Array(12)),o=await Y(n,a,H),p=X.encode(JSON.stringify(e)),d=await crypto.subtle.encrypt({name:"AES-GCM",iv:i},o,p);return{app:"slap-journal",version:1,encrypted:!0,kdf:{iterations:H,saltB64:U(a)},cipher:{ivB64:U(i),dataB64:U(new Uint8Array(d))}}},pt=async(e,n)=>{const a=B(e.kdf.saltB64),i=B(e.cipher.ivB64),o=B(e.cipher.dataB64),p=await Y(n,a,e.kdf.iterations),d=await crypto.subtle.decrypt({name:"AES-GCM",iv:N(i)},p,N(o)),S=dt.decode(d),u=JSON.parse(S);if(!Array.isArray(u))throw new Error("Decrypted data is invalid.");return u.filter(P)},P=e=>{if(typeof e!="object"||e===null)return!1;const n=e;return typeof n.id=="string"&&typeof n.createdAtIso=="string"&&typeof n.updatedAtIso=="string"&&typeof n.subject=="string"&&typeof n.body=="string"},z=e=>{if(typeof e!="object"||e===null)return!1;const n=e;return n.app==="slap-journal"&&n.version===1&&n.encrypted===!1&&Array.isArray(n.entries)},Q=e=>{if(typeof e!="object"||e===null)return!1;const n=e;if(n.app!=="slap-journal"||n.version!==1||n.encrypted!==!0)return!1;const a=n.kdf,i=n.cipher;return!!a&&typeof a.iterations=="number"&&typeof a.saltB64=="string"&&!!i&&typeof i.ivB64=="string"&&typeof i.dataB64=="string"},W=e=>{const n=new Date(e);return Number.isNaN(n.getTime())?{date:"Unknown",time:"Unknown"}:{date:n.toLocaleDateString(),time:n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}},I=e=>({app:"slap-journal",version:1,encrypted:!1,entries:e}),yt=({ctx:e})=>{const[n,a]=c.useState(!0),[i,o]=c.useState(null),[p,d]=c.useState(!1),[S,u]=c.useState(null),[b,y]=c.useState(!0),[J,j]=c.useState(""),[k,D]=c.useState(""),[E,T]=c.useState(""),[F,L]=c.useState(""),[A,O]=c.useState(""),[R,K]=c.useState(""),[g,f]=c.useState([]),M=c.useRef(null),G=c.useMemo(()=>[...g].sort((t,s)=>s.createdAtIso.localeCompare(t.createdAtIso)),[g]),m=async t=>{await e.vfs.writeText(C,JSON.stringify(t,null,2))},Z=async()=>{a(!0),o(null);try{const t=await e.vfs.readText(C);if(!t){d(!1),u(null),y(!0),f([]),await m(I([]));return}const s=JSON.parse(t);if(z(s)){d(!1),u(null),y(!0),j(""),f(s.entries.filter(P));return}if(Q(s)){d(!0),u(s),y(!1),j(""),f([]);return}throw new Error("journal.json has an unsupported format.")}catch(t){o(t instanceof Error?t.message:"Failed to load journal.")}finally{a(!1)}};c.useEffect(()=>{Z()},[e.vfs]);const _=async t=>{if(!p){await m(I(t)),f(t);return}if(!b||!J)throw new Error("Unlock journal before saving changes.");const s=await V(t,J);await m(s),u(s),f(t)},$=async()=>{if(o(null),!A.trim()){o("Subject is required.");return}const t=new Date().toISOString(),s={id:crypto.randomUUID(),createdAtIso:t,updatedAtIso:t,subject:A.trim(),body:R.trim()};try{const l=[s,...g];await _(l),O(""),K("")}catch(l){o(l instanceof Error?l.message:"Failed to save journal entry.")}},tt=async t=>{o(null);try{const s=g.filter(l=>l.id!==t);await _(s)}catch(s){o(s instanceof Error?s.message:"Failed to delete entry.")}},et=async()=>{if(o(null),!E||E!==F){o("Passwords must match.");return}try{const t=await V(g,E);await m(t),d(!0),u(t),y(!0),j(E),T(""),L("")}catch(t){o(t instanceof Error?t.message:"Failed to enable encryption.")}},nt=async()=>{if(o(null),!S){o("No encrypted journal found.");return}try{const t=await pt(S,k);f(t),j(k),D(""),y(!0)}catch{o("Incorrect password or corrupted encrypted journal.")}},rt=()=>{y(!1),f([]),j(""),o(null)},st=async()=>{if(o(null),!b){o("Unlock before disabling encryption.");return}try{await m(I(g)),d(!1),u(null),y(!0),j("")}catch(t){o(t instanceof Error?t.message:"Failed to disable encryption.")}},ot=async()=>{o(null);try{const t=await e.vfs.readText(C);if(!t){o("No journal data found to export.");return}const s=new Blob([t],{type:"application/json"}),l=URL.createObjectURL(s),w=document.createElement("a");w.href=l,w.download="journal.json",w.click(),URL.revokeObjectURL(l)}catch(t){o(t instanceof Error?t.message:"Export failed.")}},at=async t=>{const s=JSON.parse(t);if(z(s)){const l={...s,entries:s.entries.filter(P)};await m(l),d(!1),u(null),y(!0),j(""),f(l.entries);return}if(Q(s)){await m(s),d(!0),u(s),y(!1),j(""),f([]);return}throw new Error("Unsupported journal.json format.")},it=async t=>{var l;const s=((l=t.target.files)==null?void 0:l[0])??null;if(t.target.value="",!!s){o(null);try{const w=await s.text();await at(w)}catch(w){o(w instanceof Error?w.message:"Import failed.")}}},lt=p?b?"Encryption is enabled and journal is unlocked.":"Encryption is enabled. Unlock required to view entries.":"Encryption is disabled.";return r.jsxs(ct,{title:"Journal",children:[r.jsx(q,{title:"Private Journal"}),n?r.jsx(x,{children:"Loading journal..."}):null,n?null:r.jsx(x,{children:lt}),i?r.jsxs(x,{children:["Error: ",i]}):null,r.jsxs("div",{className:"slap-button-row",children:[r.jsx(h,{title:"Export journal.json",onClick:()=>void ot()}),r.jsx(h,{title:"Import journal.json",onClick:()=>{var t;return(t=M.current)==null?void 0:t.click()}})]}),r.jsx("input",{ref:M,type:"file",accept:"application/json,.json",onChange:t=>void it(t),style:{display:"none"}}),!n&&p&&!b?r.jsxs(r.Fragment,{children:[r.jsx(v,{label:"Unlock Password",value:k,onChange:D,type:"password"}),r.jsx(h,{title:"Unlock Journal",onClick:()=>void nt()})]}):null,!n&&!p?r.jsxs(r.Fragment,{children:[r.jsx(v,{label:"New Password",value:E,onChange:T,type:"password"}),r.jsx(v,{label:"Confirm Password",value:F,onChange:L,type:"password"}),r.jsx(h,{title:"Enable Encryption",onClick:()=>void et()})]}):null,!n&&p&&b?r.jsxs("div",{className:"slap-button-row",children:[r.jsx(h,{title:"Lock",onClick:rt}),r.jsx(h,{title:"Disable Encryption",onClick:()=>void st()})]}):null,!n&&(!p||b)?r.jsxs(r.Fragment,{children:[r.jsx(v,{label:"Subject",value:A,onChange:O}),r.jsxs("label",{className:"slap-input-wrap",children:[r.jsx("span",{children:"More"}),r.jsx("textarea",{className:"slap-input",rows:5,value:R,onChange:t=>K(t.target.value)})]}),r.jsx(h,{title:"Save Entry",onClick:()=>void $()}),G.length===0?r.jsx(x,{children:"No entries yet."}):null,G.map(t=>{const s=W(t.createdAtIso),l=W(t.updatedAtIso);return r.jsxs("article",{className:"slap-shell",style:{borderTop:"1px solid #c5b9a5",paddingTop:"0.6rem"},children:[r.jsx(q,{title:t.subject}),r.jsxs(x,{children:["Created: ",s.date," at ",s.time]}),r.jsxs(x,{children:["Updated: ",l.date," at ",l.time]}),r.jsx(x,{children:t.body||"(No additional notes)"}),r.jsx(h,{title:"Delete",onClick:()=>void tt(t.id)})]},t.id)})]}):null]})},wt={id:"journal",title:"Journal",author:"Joel",description:"Password-protected journal with import/export.",icon:"ðŸ““",Preview:ut,Application:yt};export{wt as journalManifest};
