import{r as i,j as g}from"./index-DTMkQmTp.js";import{S as me,a as pe,b as F,d as O}from"./index-DiShqxyg.js";const ee=480,ve=e=>g.jsxs("article",{children:[g.jsx("strong",{children:"Fireplace"}),g.jsx("p",{children:"Old school particle flames with motion and sound boost."})]}),k=(e,o,t)=>Math.min(t,Math.max(o,e)),u=(e,o)=>e+Math.random()*(o-e),ge=(e,o=.06)=>{const t=Math.floor(e.sampleRate*o),s=e.createBuffer(1,t,e.sampleRate),c=s.getChannelData(0);for(let h=0;h<t;h+=1)c[h]=(Math.random()*2-1)*.6;return s},he=(e,o,t,s)=>{const c=k(s-1,0,3),h=1+c*.25,m=1+c*.08,v=1+c*.12,R=u(-Math.PI*.65,-Math.PI*.35),S=u(35,65)*m;return{x:e+u(-18,18),y:o+u(-4,4),vx:Math.cos(R)*S+t*20,vy:Math.sin(R)*S,size:u(6,14)*h,life:u(.6,1.1)*v,age:0,kind:"flame"}},we=(e,o,t,s,c)=>{const h=k(s-1,0,3),m=1+h*.22,v=1+h*.35,R=1+c*1.8,S=u(-Math.PI*.95,-Math.PI*.45),D=u(16,28)*(1+c*.25),C=u(-12,12)*R;return{x:e+u(-20,20)*R,y:o+u(-6,6),vx:Math.cos(S)*D+t*15+C,vy:Math.sin(S)*D,size:u(12,22)*m,life:u(2.2,3.6)*v,age:0,kind:"smoke"}},be=(e,o,t)=>{const s=e.createLinearGradient(0,0,0,t);s.addColorStop(0,"#14110d"),s.addColorStop(1,"#2f1f12"),e.fillStyle=s,e.fillRect(0,0,o,t);const c=e.createRadialGradient(o/2,t*.82,5,o/2,t*.82,t*.35);c.addColorStop(0,"rgba(255, 184, 92, 0.35)"),c.addColorStop(1,"rgba(255, 184, 92, 0)"),e.fillStyle=c,e.fillRect(0,t*.5,o,t*.5),e.fillStyle="#2d1b0f",e.fillRect(o*.18,t*.84,o*.64,t*.08),e.fillStyle="#3c2615",e.fillRect(o*.2,t*.9,o*.6,t*.06)},Me=(e,o)=>{e.save(),e.globalCompositeOperation="lighter";for(const t of o){if(t.kind!=="flame")continue;const s=t.age/t.life,c=1-s,h=t.size*(1+s*.6),m=k(.9*(1-s),0,.9),v=Math.round(200+55*c),R=Math.round(80+130*c),S=Math.round(20+40*c);e.fillStyle=`rgba(${v}, ${R}, ${S}, ${m})`,e.beginPath(),e.ellipse(t.x,t.y,h*.7,h,0,0,Math.PI*2),e.fill()}e.restore(),e.save(),e.globalCompositeOperation="source-over";for(const t of o){if(t.kind!=="smoke")continue;const s=t.age/t.life,c=t.size*(1+s*.8),h=k(.35*(1-s),0,.35),m=Math.round(90+50*s);e.fillStyle=`rgba(${m}, ${m}, ${m}, ${h})`,e.beginPath(),e.ellipse(t.x,t.y,c*.8,c,0,0,Math.PI*2),e.fill()}e.restore()},Se=()=>{var Z;const e=i.useRef(null),o=i.useRef(null),t=i.useRef([]),s=i.useRef([{id:"base",relativeX:.5,relativeY:.82,age:0,ttl:null,boost:0,flameSpawn:0,smokeSpawn:0}]),c=i.useRef({width:320,height:420}),h=i.useRef(null),m=i.useRef(0),v=i.useRef({active:!1,lastX:0,lastTime:0}),R=i.useRef("idle"),S=i.useRef(0),D=i.useRef(0),C=i.useRef(null),b=i.useRef(null),I=i.useRef(null),_=i.useRef(0),[x,L]=i.useState("idle"),[T,X]=i.useState("idle"),[P,$]=i.useState("idle"),[te,ne]=i.useState("still"),[re,J]=i.useState(0),[ie,H]=i.useState(1),[oe,Q]=i.useState(0),V=typeof window<"u"&&"DeviceMotionEvent"in window,Y=typeof navigator<"u"&&!!((Z=navigator.mediaDevices)!=null&&Z.getUserMedia),K=typeof window<"u"&&("AudioContext"in window||"webkitAudioContext"in window);i.useEffect(()=>{R.current=x},[x]),i.useEffect(()=>{const r=e.current;if(!r)return;const l=()=>{const d=r.getBoundingClientRect(),p=Math.max(200,d.width),M=Math.max(240,d.height),a=window.devicePixelRatio||1;r.width=Math.floor(p*a),r.height=Math.floor(M*a);const y=r.getContext("2d");y&&y.setTransform(a,0,0,a,0,0),c.current={width:p,height:M}};l(),window.addEventListener("resize",l);const f=d=>{const p=r.getContext("2d");if(!p)return;const M=h.current??d,a=Math.min(.05,(d-M)/1e3);h.current=d;const y=c.current,z=k(m.current,-1,1),A=S.current,j=1+A*2.2;_.current=j,b.current&&(b.current.gain.gain.value=k(.03+j*.02,.02,.12));const W=s.current;for(let w=W.length-1;w>=0;w-=1){const n=W[w];if(n.ttl!==null&&(n.age+=a,n.age>=n.ttl)){W.splice(w,1);continue}const E=j+n.boost,U=58*E,B=18*(.7+E*.45);n.flameSpawn+=a*U,n.smokeSpawn+=a*B;const N=y.width*n.relativeX+z*10,G=y.height*n.relativeY;for(;n.flameSpawn>=1;)t.current.push(he(N,G,z,E)),n.flameSpawn-=1;for(;n.smokeSpawn>=1;)t.current.push(we(N,G,z,E,A)),n.smokeSpawn-=1}t.current.length>ee&&t.current.splice(0,t.current.length-ee),!v.current.active&&R.current!=="active"&&(m.current*=.965,Math.abs(m.current)<.01&&(m.current=0));const q=t.current;for(let w=q.length-1;w>=0;w-=1){const n=q[w];if(n.age+=a,n.age>=n.life){q.splice(w,1);continue}const E=n.kind==="flame"?-24:-20,U=n.kind==="flame"?18:6;if(n.vx+=z*U*a,n.vx+=(Math.random()-.5)*(n.kind==="flame"?8:4)*a,n.vy+=E*a,n.x+=n.vx*a,n.y+=n.vy*a,n.kind==="smoke"){const B=A;n.vx+=(Math.random()-.5)*(6+B*24)*a,n.vx*=.992,n.vy*=.996}else n.vx*=.985,n.vy*=.99}if(C.current){const{analyser:w,data:n}=C.current;w.getByteTimeDomainData(n);let E=0;for(const N of n){const G=(N-128)/128;E+=G*G}const U=Math.sqrt(E/n.length),B=k(U*2.2,0,1);S.current=B,d-D.current>200&&J(Math.round(B*100))}else S.current=0,d-D.current>200&&J(0);if(d-D.current>200){const w=m.current,n=w>.1?"right":w<-.1?"left":"still";ne(`${n} ${Math.round(Math.abs(w)*100)}%`),H(s.current.length),Q(Math.max(0,s.current.length-1)),D.current=d}be(p,y.width,y.height),Me(p,q),o.current=requestAnimationFrame(f)};return o.current=requestAnimationFrame(f),()=>{window.removeEventListener("resize",l),o.current!==null&&(cancelAnimationFrame(o.current),o.current=null)}},[]),i.useEffect(()=>{if(!V||x!=="active")return;const r=l=>{const f=l.accelerationIncludingGravity;if(!f)return;const d=f.x??0,p=k(d/5,-1,1);m.current=m.current*.9+p*.1};return window.addEventListener("devicemotion",r),()=>{window.removeEventListener("devicemotion",r)}},[x,V]),i.useEffect(()=>{if(T!=="active"){C.current&&(C.current.stream.getTracks().forEach(r=>r.stop()),C.current.ctx.close(),C.current=null);return}if(!Y){X("unavailable");return}(async()=>{try{const r=await navigator.mediaDevices.getUserMedia({audio:!0}),l=new(window.AudioContext||window.webkitAudioContext),f=l.createAnalyser();f.fftSize=256,l.createMediaStreamSource(r).connect(f);const p=new Uint8Array(f.fftSize);C.current={ctx:l,analyser:f,data:p,stream:r}}catch{X("denied")}})()},[T,Y]),i.useEffect(()=>{if(P!=="active"){I.current!==null&&(window.clearTimeout(I.current),I.current=null),b.current&&(b.current.ctx.close(),b.current=null);return}if(!K){$("unavailable");return}if(b.current)return;const r=window.AudioContext||window.webkitAudioContext;if(!r){$("unavailable");return}const l=new r,f=l.createGain();f.gain.value=.05,f.connect(l.destination);const d=ge(l);b.current={ctx:l,gain:f,buffer:d},l.resume();const p=()=>{if(!b.current)return;const{ctx:a,gain:y,buffer:z}=b.current,A=a.createBufferSource();A.buffer=z,A.playbackRate.value=u(.7,1.4);const j=a.createGain();j.gain.setValueAtTime(1e-4,a.currentTime),j.gain.linearRampToValueAtTime(u(.02,.08),a.currentTime+.01),j.gain.exponentialRampToValueAtTime(1e-4,a.currentTime+u(.06,.12)),A.connect(j),j.connect(y),A.start(),A.stop(a.currentTime+.15)},M=()=>{if(!b.current)return;const a=k(_.current,0,3),z=k(230-a*40,70,230)+u(-20,40);I.current=window.setTimeout(()=>{p(),M()},z)};return M(),()=>{I.current!==null&&(window.clearTimeout(I.current),I.current=null),b.current&&(b.current.ctx.close(),b.current=null)}},[P,K]);const ae=async()=>{if(!V){L("unavailable");return}if(x==="active"){L("idle");return}const r=DeviceMotionEvent;if(typeof(r==null?void 0:r.requestPermission)=="function")try{if(await r.requestPermission()!=="granted"){L("denied");return}}catch{L("denied");return}L("active")},se=()=>{if(T==="active"){X("idle");return}if(!Y){X("unavailable");return}X("active")},ce=()=>{if(P==="active"){$("idle");return}if(!K){$("unavailable");return}$("active")},le=()=>{const r=s.current;if(r.length>=10){let f=-1,d=-1;for(let p=0;p<r.length;p+=1){const M=r[p];M.id!=="base"&&M.age>d&&(d=M.age,f=p)}f>=0&&r.splice(f,1)}const l={id:crypto.randomUUID(),relativeX:u(.28,.72),relativeY:u(.79,.86),age:0,ttl:u(14,24),boost:u(.6,1.5),flameSpawn:0,smokeSpawn:0};r.push(l),H(r.length),Q(Math.max(0,r.length-1))},ue=i.useMemo(()=>x==="active"?"Disable Motion":x==="unavailable"?"Motion Unsupported":x==="denied"?"Motion Denied":"Enable Motion",[x]),fe=i.useMemo(()=>T==="active"?"Disable Mic":T==="unavailable"?"Mic Unsupported":T==="denied"?"Mic Denied":"Enable Mic",[T]),de=i.useMemo(()=>P==="active"?"Disable Crackle":P==="unavailable"?"Crackle Unsupported":"Enable Crackle",[P]);return g.jsxs(me,{title:"Fireplace",children:[g.jsx(pe,{title:"Fireplace"}),g.jsx(F,{children:"Old school particle flames and smoke. Tilt or make noise to stoke the fire."}),g.jsxs("div",{className:"slap-button-row",children:[g.jsx(O,{title:ue,onClick:()=>void ae(),disabled:x==="unavailable"}),g.jsx(O,{title:fe,onClick:se,disabled:T==="unavailable"}),g.jsx(O,{title:de,onClick:ce,disabled:P==="unavailable"}),g.jsx(O,{title:"Add Kindling",onClick:le})]}),g.jsxs(F,{children:["Wind: ",te]}),g.jsxs(F,{children:["Mic boost: ",T==="active"?`${re}%`:"off"]}),g.jsxs(F,{children:["Crackle: ",P==="active"?"on":"off"]}),g.jsxs(F,{children:["Fires: ",ie," (kindling piles: ",oe,")"]}),g.jsx("div",{className:"fireplace-stage",children:g.jsx("canvas",{ref:e,className:"fireplace-canvas",onPointerDown:r=>{v.current.active=!0,v.current.lastX=r.clientX,v.current.lastTime=performance.now(),r.currentTarget.setPointerCapture(r.pointerId)},onPointerMove:r=>{if(!v.current.active)return;const l=performance.now(),f=r.clientX-v.current.lastX,d=Math.max(1,l-v.current.lastTime),p=f/d,M=k(p*1.5,-1,1);m.current=m.current*.7+M*.3,v.current.lastX=r.clientX,v.current.lastTime=l},onPointerUp:()=>{v.current.active=!1},onPointerCancel:()=>{v.current.active=!1},onPointerLeave:()=>{v.current.active=!1}})}),g.jsx(F,{children:"Tip: Drag on the fire to simulate wind. Tap Enable Motion or Enable Mic to grant permissions on mobile."})]})},xe={id:"fireplace",title:"Fireplace",author:"Joel",description:"Cozy particle fire with motion and sound response.",icon:"FIRE",Preview:ve,Application:Se};export{xe as fireplaceManifest};
